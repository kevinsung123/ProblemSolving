/**
 * ColorEditor.js
 * version 0.1.0
 * built in 2016-03-25
 * author prevdev@gmail.com
 *
 *
 * Usage
 *  <div id="my-editor"></div>
 *	<script type="text/javascript">
 *		var me = document.getElementById('my-editor');
 *		var ce = ColorEditor.register(me, 'c');
 *	</script>
 *
 **/
var ColorEditor=function(){var _object={};var colorScripter;var ceDOM;var hooks={};var codeText;var previousLineNums;var keuUpBlocked=false;var rawCodeText="";var isWebkit=(navigator.userAgent.indexOf("WebKit")!=-1);var isFireFox=(navigator.userAgent.indexOf("Firefox")!=-1);var realTimeEnabled;var colorScripterJSLoadingNow=false;var sdkLoaderIntv;var sdkLoadReqTime=0;_object.init=function(targetDOM,language,stylePackage){if(!targetDOM){throw Error("targetDOM is null");return}if(typeof ColorScripter=="undefined"){if(!colorScripterJSLoadingNow){var csjs=document.createElement("script");var script1=document.getElementsByTagName("script")[0];csjs.src="http://colorscripter.com/js/colorscripter.min.js";script1.parentNode.insertBefore(csjs,script1);colorScripterJSLoadingNow=true;sdkLoaderIntv=setInterval(function(){_object.init(targetDOM,language,stylePackage)},20)}return}if(++sdkLoadReqTime>50){alert("Error: cannot load colorscripter sdk file");clearInterval(sdkLoaderIntv);sdkLoaderIntv=null}if(sdkLoaderIntv){clearInterval(sdkLoaderIntv);sdkLoaderIntv=null}if(isWebkit||isFireFox)realTimeEnabled=true;if(!language)language="text";colorScripter=new ColorScripter(language);if(stylePackage)colorScripter.selectStylePackage(stylePackage);var html='<div class="ColorEditor">\<div class="ce-wrap">\<div class="ce-linenumber">\<ol>\<li>1</li>\</ol>\</div>\<div class="ce-text-area"></div>\</div>\</div>';targetDOM.innerHTML=html;ceDOM=gebcn(targetDOM,"ColorEditor")[0];if(realTimeEnabled)_object.enableRealTime(true);else _object.disableRealTime(true);_object.updateCode("",true);_object.resize()};_object.getColorScripter=function(){return colorScripter};_object.getEditorDOM=function(){return ceDOM};_object.getCodeTextDOM=function(){return codeText};_object.getRawCodeText=function(){return rawCodeText};_object.updateCode=function(code,disableFocus){if(code){updateRawCodeText(code);code=code.split("\r\n").join("\n");code=code.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;");if(realTimeEnabled)codeText.innerHTML=code;else codeText.value=code}codeChangeHandler(null,disableFocus)};_object.resize=function(){codeText.style.width=(ceDOM.clientWidth-51-14)+"px";codeText.style.height=(ceDOM.clientHeight-21)+"px";if(hooks["resize"])hooks["resize"](codeText,ceDOM)};_object.setHook=function(type,func){hooks[type]=func};_object.getRealTimeEnabled=function(){return realTimeEnabled};_object.enableRealTime=function(forceUpdate){if(realTimeEnabled&&!forceUpdate)return;realTimeEnabled=true;var wrapper=gebcn(ceDOM,"ce-text-area")[0];if(codeText)wrapper.removeChild(codeText);codeText=document.createElement('pre');codeText.setAttribute('class','ce-code-text');codeText.setAttribute('contenteditable',true);codeText.setAttribute('spellcheck',false);codeText.innerHTML='<div></div>';codeText.addEventListener("compositionstart",codeTextComposeHandler);codeText.addEventListener("compositionupdate",codeTextComposeHandler);codeText.addEventListener("compositionend",codeTextComposeHandler);codeText.addEventListener("keydown",codeChangePreventHandler);codeText.addEventListener("keyup",codeChangeHandler);codeText.addEventListener("copy",codeCopyHandler);codeText.addEventListener("paste",codePasteHandler);wrapper.appendChild(codeText);_object.updateCode(rawCodeText);_object.resize()};_object.disableRealTime=function(forceUpdate){if(!realTimeEnabled&&!forceUpdate)return;realTimeEnabled=false;var wrapper=gebcn(ceDOM,"ce-text-area")[0];if(codeText)wrapper.removeChild(codeText);codeText=document.createElement('textarea');codeText.setAttribute('class','ce-code-text');codeText.setAttribute('spellcheck',false);wrapper.appendChild(codeText);_object.updateCode(rawCodeText);_object.resize()};function gebcn(dom,className){if(dom.getElementsByClassName)return dom.getElementsByClassName(className);else if(dom.querySelectorAll)return dom.querySelectorAll("."+className);else if(dom.getElementsByTagName){var t=dom.getElementsByTagName("*");var n=[];for(var i=0;i<t.length;i++){var classLists=t[i].className.split(" ");if(classLists.indexOf(className)!=-1)n.push(t[i])}return n}}function codeTextComposeHandler(e){if(!realTimeEnabled)return;if(hooks["codeTextCompose"])hooks["codeTextCompose"](e);if(e.type=="compositionend")keuUpBlocked=false;else keuUpBlocked=true}function codeChangePreventHandler(e){if(!realTimeEnabled)return;if(hooks["keyDown"])hooks["keyDown"](e);keuUpBlocked=false;pastedCode=null;if(isFireFox){if(e.metaKey==true&&e.key!="v"){keuUpBlocked=true}if(e.keyCode===13){document.execCommand('insertHTML',false,'\n');e.preventDefault();return false}}if(e.keyCode===9){document.execCommand('insertHTML',false,'	');e.preventDefault();return false}if(e.key=='&'&&realTimeEnabled){document.execCommand('insertHTML',false,'&amp;');e.preventDefault();return false}updateLineNumber()}function codeCopyHandler(e){if(e&&e.clipboardData&&e.clipboardData.setData){var start=window.getSelection().getRangeAt(0).startOffset;var end=window.getSelection().getRangeAt(0).endOffset;e.clipboardData.setData('text/plain',rawCodeText.substring(start,end))}}function codePasteHandler(e){if(hooks["codePasted"])hooks["codePasted"](e);if(e&&e.clipboardData&&e.clipboardData.getData){if(/text\/plain/.test(e.clipboardData.types)){var pastedCode=e.clipboardData.getData('text/plain');pastedCode=pastedCode.split("\r\n").join("\n");pastedCode=pastedCode.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;");e.preventDefault();document.execCommand("insertHTML",false,pastedCode)}}}function updateRawCodeText(forcedText){if(forcedText){rawCodeText=forcedText;return}if(realTimeEnabled){rawCodeText=codeText.innerHTML;if(isFireFox&&rawCodeText.substr(0,4)=="<br>")rawCodeText="\n"+rawCodeText;rawCodeText=rawCodeText.replace(/<\/div><div[^>]*>/g,"\n").replace(/<[\s\S]*?>/g,"").split("&lt;").join("<").split("&gt;").join(">").split("&nbsp;").join(" ").split("&amp;").join("&")}else rawCodeText=codeText.value}function codeChangeHandler(e,disableFocus){if(e!=null&&hooks["keyUp"])hooks["keyUp"](e);var range;if(realTimeEnabled&&disableFocus!=true){if(window.getSelection().type=="Range"||keuUpBlocked)return;try{range=window.getSelection().getRangeAt(0)}catch(error){return}}updateRawCodeText(null);updateLineNumber();if(realTimeEnabled){if(gebcn(document,"focus-caret").length){d=gebcn(document,"focus-caret")[0];d.parentNode.removeChild(d)}var caretSpan=document.createElement("s");caretSpan.id="focus-caret";if(range!=null)range.insertNode(caretSpan);var html=codeText.innerHTML.replace(/<\/div><div[^>]*>/g,"\n").replace(/<\/?br[\s\S]*?>/g,"").replace(/<\/?span[\s\S]*?>/g,"").replace(/<\/?font[\s\S]*?>/g,"").replace(/<\/?div[\s\S]*?>/g,"").replace("<i></i>","").split("&lt;").join("<").split("&gt;").join(">").split("&nbsp;").join(" ").split("&amp;").join("&");var x=html.indexOf('<s id="focus-caret"></s>');var n=0;if(x==-1){caretSpan.remove()}html=colorScripter.color(rawCodeText).split("&nbsp;").join(" ");for(var i=0;i<html.length+1;i++){if(n==x){html=html.substr(0,i)+"<i></i>"+html.substr(i);break}if(html[i]=="<"){i=html.indexOf(">",i+1);continue}else if(html.substr(i,6)=="&nbsp;")i+=5;else if(html.substr(i,5)=="&amp;")i+=4;else if(html.substr(i,4)=="&lt;"||html.substr(i,4)=="&gt;")i+=3;n++}var cht=null;if(hooks["codeChanging"])cht=hooks["codeChanging"](html,codeText);if(cht)html=cht;else{if(html.indexOf("\n")==-1)html="<div>"+html+"</div>";else html="<div>"+html.split("\n").join("</div><div>")+"</div>"}codeText.blur();codeText.innerHTML=html;if(range!=null)codeText.focus();var i=codeText.getElementsByTagName("i")[0];if(i){var range=document.createRange();range.selectNode(i);var selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);range.deleteContents()}}codeText.style.color=colorScripter.stylePackage.normal;ceDOM.style.backgroundColor=(colorScripter.stylePackage.backgroundColor)?colorScripter.stylePackage.backgroundColor:"";if(codeText.tagName!="PRE"){codeText.style.backgroundColor=ceDOM.style.backgroundColor}if(hooks["codeChanged"])hooks["codeChanged"](html,codeText)}function updateLineNumber(){var lineNums=rawCodeText.split("\n").length;if(lineNums!=previousLineNums){var lnObj=gebcn(ceDOM,"ce-linenumber")[0].getElementsByTagName("ol")[0];lnObj.innerHTML="";for(var i=0;i<lineNums;i++){var d=document.createElement("li");d.innerHTML=i+1;lnObj.appendChild(d)}}return lineNums}return _object};ColorEditor.register=function(domObj,language,stylePackage){if(!domObj){throw Error("domObj is null");return null}var ce=new ColorEditor();ce.init(domObj,language,stylePackage);return ce};